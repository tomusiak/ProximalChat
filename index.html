<!DOCTYPE html>
<html>
<body>

<canvas id="myCanvas" width="1000" height="1000"
style="border:0px solid #c3c3c3;">
</canvas>



<audio id = "audio"> <source src="buzzcut.mp3" crossorigin="anonymous" type = "audio/mpeg" ></audio>

<script type = "text/javascript">
  circles = [];
  lines = [];
  audios = [];
  player_circles = [];
  var audioBuffer;
  var hit = 0;
  sourceList = [];
  var objImage= null;
  placed_player = false;
  player_x = 0;
  player_y = 0;

  function init(){
    circles = [];
    lines = [];
    audios = [];
    for (i= 0; i < 5; i++) {
      for (j = 0; j < 5; j++) {
        circles.push({
          colour: '#FF0000',
          x: 0 + 250 * i,
          y: 0 + 250 * j,
          radius: 10
          }
        );
        lines.push( {
          start_x: 0 + 250*i,
          start_y: 0,
          end_x: 250*i,
          end_y: 1000,
          }
        );
        lines.push( {
          start_x: 0,
          start_y: 0 + 250*j,
          end_x: 1000,
          end_y: 0 + 250*j,
          }
        );
      }
    }
    playerCircles = [];
    playerCircles.push({
      color:'00FF00',
      x: 0,
      y: 0,
      radius: 10
      }
    );
    objImage = playerCircles[0];
  }

  function getKeyAndMove(e){
    var key_code=e.which||e.keyCode;
    switch(key_code){
      case 37: //left arrow key
        moveLeft();
        break;
      case 38: //Up arrow key
        moveUp();
        break;
      case 39: //right arrow key
        moveRight();
        break;
      case 40: //down arrow key
        moveDown();
        break;
    }
  }
  function moveLeft(){
    objImage.x = objImage.x - 5;
    player_x = objImage.x;
    redrawCanvas();
    audios.forEach(song => {
      (song.gain).gain.value = 62500 / (Math.pow((Math.sqrt(Math.pow(player_x-song.x,2)+Math.pow(player_y-song.y,2))),2) + 62500);
    });
  }
  function moveUp(){
    objImage.y = objImage.y - 5;
    player_y = objImage.y;
    audios.forEach(song => {
      (song.gain).gain.value = 62500 / (Math.pow((Math.sqrt(Math.pow(player_x-song.x,2)+Math.pow(player_y-song.y,2))),2) + 62500);
    });
    redrawCanvas();
  }
  function moveRight(){
    objImage.x = objImage.x + 5;
    player_x = objImage.x;
    audios.forEach(song => {
      (song.gain).gain.value = 62500 / (Math.pow((Math.sqrt(Math.pow(player_x-song.x,2)+Math.pow(player_y-song.y,2))),2) + 62500);
    });
    redrawCanvas();
  }
  function moveDown(){
    objImage.y = objImage.y + 5;
    player_y = objImage.y;
    audios.forEach(song => {
      (song.gain).gain.value = 62500 / (Math.pow((Math.sqrt(Math.pow(player_x-song.x,2)+Math.pow(player_y-song.y,2))),2) + 62500);
    });
    redrawCanvas();
  }

  window.onload=init();

  const AudioContext = window.AudioContext || window.webkitAudioContext;

  var elem = document.getElementById('myCanvas');
  ctx = elem.getContext('2d');

  CanvasRenderingContext2D.prototype.clear =
  CanvasRenderingContext2D.prototype.clear || function (preserveTransform) {
    if (preserveTransform) {
      this.save();
      this.setTransform(1, 0, 0, 1, 0, 0);
    }
    this.clearRect(0, 0, this.canvas.width, this.canvas.height);
    if (preserveTransform) {
      this.restore();
    }
  };

	audios.push ( {
		sound: "buzzcut.ogg",
		x: 0,
		y: 0,
    context: null,
    element: null,
    gain: null,
    source: null,
	},
		{
			sound: "digger.ogg",
			x: 1000,
			y: 1000,
      context: null,
      element: null,
      gain: null,
      source: null,
			}
	);

	function setupAudios(circleX,circleY) {
		sourceList.forEach(source => {
			source.stop();
		});
		audios.forEach(song => {
			audioContext = new AudioContext();
			audioElement = document.querySelector('audio');
			gainNode = audioContext.createGain();
			let source = audioContext.createBufferSource();
			var myRequest = new Request(song.sound);
			fetch(myRequest).then(function(response) {
		    return response.arrayBuffer();
		  }).then(function(buffer) {
		    audioContext.decodeAudioData(buffer, function(decodedData) {
		      source.buffer = decodedData;
		    });
		  });
			if (audioContext.state === 'suspended') {
				audioContext.resume();
			}
			source.start(5);
			sourceList.push(source);
      song.context = audioContext;
      song.element = audioElement;
      song.gain = gainNode;
      song.source = source;
      (song.gain).gain.value = 62500 / (Math.pow((Math.sqrt(Math.pow(circleX-song.x,2)+Math.pow(circleY-song.y,2))),2) + 62500);
      source.connect(song.gain);
      (song.gain).connect((song.context).destination);
			//audioElement.play();
		});
	}

  function redrawCanvas() {
    ctx.clear();
    lines.forEach(lines =>  {
      ctx.beginPath();
      ctx.moveTo(lines.start_x,lines.start_y);
      ctx.lineTo(lines.end_x,lines.end_y)
      ctx.stroke();
    })
    circles.forEach(circle => {
      ctx.beginPath();
      ctx.arc(circle.x, circle.y, circle.radius, 0, 2 * Math.PI, false);
      ctx.fillStyle = circle.colour;
      ctx.fill();
    });
    if (placed_player) {
      playerCircles.forEach(circle => {
        ctx.beginPath();
        ctx.arc(circle.x, circle.y, circle.radius, 0, 2 * Math.PI, false);
        ctx.fillStyle = '#00FF00'
        ctx.fill();
      });
    }
  }

  elem.addEventListener('click', function() {
    var x = event.pageX,
        y = event.pageY;
    if (!placed_player) {
      player_x = x;
      player_y = y;
      ctx.beginPath();
      ctx.arc(x, y, 10, 0, 2 * Math.PI, false);
      ctx.fillStyle = '#00FF00';
      ctx.fill();
      playerCircles[0].x = x;
      playerCircles[0].y = y;
      objImage = playerCircles[0];
      placed_player = true;
      setupAudios(x,y);
    }
  }, false);

  redrawCanvas();
</script>

<body onkeydown='getKeyAndMove(event)'>
</body>
</body>
</html>
